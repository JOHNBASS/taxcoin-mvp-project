# Build stage
FROM node:20-alpine AS builder

WORKDIR /app

# ğŸš€ å„ªåŒ–: ä½¿ç”¨å®˜æ–¹ npm é¡åƒï¼ˆSelf SDK åœ¨å®˜æ–¹æºï¼‰
RUN npm config set registry https://registry.npmjs.org

# ğŸš€ å„ªåŒ–: å…ˆè¤‡è£½ package files,åˆ©ç”¨ Docker å±¤ç·©å­˜
COPY package*.json ./

# ğŸš€ å„ªåŒ–: ä½¿ç”¨ --mount=type=cache åŠ é€Ÿ npm å®‰è£
# è¨­ç½®æ›´é•·çš„è¶…æ™‚æ™‚é–“å’Œä¸¦ç™¼é€£æ¥æ•¸
RUN --mount=type=cache,target=/root/.npm \
    npm config set fetch-timeout 600000 && \
    npm config set maxsockets 5 && \
    npm install --prefer-offline --no-audit

# è¤‡è£½åŸå§‹ç¢¼
COPY . .

# å»ºç½®æ‡‰ç”¨
RUN npm run build

# Production stage
FROM nginx:alpine

# ğŸš€ å„ªåŒ–: æ›´æ› Alpine é¡åƒæºåŠ é€Ÿ
RUN sed -i 's/dl-cdn.alpinelinux.org/mirrors.aliyun.com/g' /etc/apk/repositories

# å®‰è£ wget (ç”¨æ–¼å¥åº·æª¢æŸ¥)
RUN apk add --no-cache wget

# è¤‡è£½è‡ªå®šç¾© nginx é…ç½®
COPY nginx.conf /etc/nginx/conf.d/default.conf

# å¾ builder è¤‡è£½å»ºç½®çµæœ
COPY --from=builder /app/dist /usr/share/nginx/html

# æš´éœ² port 5004
EXPOSE 5004

# å•Ÿå‹• nginx
CMD ["nginx", "-g", "daemon off;"]

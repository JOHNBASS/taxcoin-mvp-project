# Build stage
FROM node:20-alpine AS builder

WORKDIR /app

# æ›´æ› Alpine é¡åƒæºç‚ºé˜¿é‡Œé›²
RUN sed -i 's/dl-cdn.alpinelinux.org/mirrors.aliyun.com/g' /etc/apk/repositories

# å®‰è£ OpenSSL å’Œå…¶ä»–å¿…è¦ä¾è³´ (Prisma éœ€è¦)
RUN apk add --no-cache openssl libc6-compat

# ğŸš€ å„ªåŒ–: ä½¿ç”¨å®˜æ–¹ npm é¡åƒï¼ˆSelf SDK åœ¨å®˜æ–¹æºï¼‰
RUN npm config set registry https://registry.npmjs.org

# ğŸš€ å„ªåŒ–: å…ˆè¤‡è£½ package files,åˆ©ç”¨ Docker å±¤ç·©å­˜
COPY package*.json ./
COPY tsconfig.json ./

# ğŸš€ å„ªåŒ–: ä½¿ç”¨ --mount=type=cache åŠ é€Ÿ npm å®‰è£
# è¨­ç½®æ›´é•·çš„è¶…æ™‚æ™‚é–“å’Œä¸¦ç™¼é€£æ¥æ•¸
RUN --mount=type=cache,target=/root/.npm \
    npm config set fetch-timeout 600000 && \
    npm config set maxsockets 5 && \
    npm install --prefer-offline --no-audit

# è¤‡è£½åŸå§‹ç¢¼
COPY src ./src
COPY prisma ./prisma

# ç”Ÿæˆ Prisma Client
RUN npx prisma generate

# ç·¨è­¯ TypeScript
RUN npm run build

# Production stage
FROM node:20-alpine

WORKDIR /app

# æ›´æ› Alpine é¡åƒæºç‚ºé˜¿é‡Œé›² (æé«˜ä¸­åœ‹å¢ƒå…§è¨ªå•é€Ÿåº¦)
RUN sed -i 's/dl-cdn.alpinelinux.org/mirrors.aliyun.com/g' /etc/apk/repositories

# å®‰è£ OpenSSLã€wget å’Œå…¶ä»–å¿…è¦ä¾è³´ (Prisma éœ€è¦)
RUN apk add --no-cache openssl libc6-compat wget

# ğŸš€ å„ªåŒ–: ä½¿ç”¨å®˜æ–¹ npm é¡åƒï¼ˆSelf SDK åœ¨å®˜æ–¹æºï¼‰
RUN npm config set registry https://registry.npmjs.org

# è¤‡è£½ package files
COPY package*.json ./

# ğŸš€ å„ªåŒ–: ä½¿ç”¨ cache mount åŠ é€Ÿç”Ÿç”¢ä¾è³´å®‰è£
RUN --mount=type=cache,target=/root/.npm \
    npm config set fetch-timeout 600000 && \
    npm config set maxsockets 5 && \
    npm install --only=production --prefer-offline --no-audit

# å¾ builder è¤‡è£½ç·¨è­¯å¾Œçš„æª”æ¡ˆ
COPY --from=builder /app/dist ./dist
COPY --from=builder /app/node_modules/.prisma ./node_modules/.prisma

# è¤‡è£½ prisma schema (ç”¨æ–¼ migration)
COPY prisma ./prisma

# å‰µå»ºä¸Šå‚³å’Œæ—¥èªŒç›®éŒ„
RUN mkdir -p /app/uploads /app/logs && \
    chown -R node:node /app

# ä½¿ç”¨é root ä½¿ç”¨è€…
USER node

# æš´éœ² port (åƒ…å…§éƒ¨ä½¿ç”¨,ä¸å°å¤–)
EXPOSE 3000

# å•Ÿå‹•æŒ‡ä»¤ (MongoDB ä¸éœ€è¦ migration)
CMD ["node", "dist/server.js"]

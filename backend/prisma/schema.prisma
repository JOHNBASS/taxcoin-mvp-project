// Prisma Schema for TAXCOIN MVP
// åƒè€ƒ: .specify/features/taxcoin-mvp-platform/data-model.md

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "mongodb"
  url      = env("DATABASE_URL")
}

// ===== åˆ—èˆ‰é¡å‹ =====

enum UserRole {
  TOURIST  // æ—…å®¢
  INVESTOR // æŠ•è³‡è€…
  MERCHANT // åº—å®¶
  ADMIN    // ç®¡ç†å“¡
}

enum KycStatus {
  PENDING  // å¾…é©—è­‰
  VERIFIED // å·²é©—è­‰
  REJECTED // å·²æ‹’çµ•
}

enum ClaimStatus {
  PENDING   // å¾…å¯©æ ¸
  APPROVED  // å·²æ ¸å‡†
  REJECTED  // å·²æ‹’çµ•
  DISBURSED // å·²ç™¼æ”¾
}

enum PoolStatus {
  RECRUITING // å‹Ÿé›†ä¸­
  FULL       // å·²æ»¿é¡
  MATURED    // å·²åˆ°æœŸ
  SETTLED    // å·²çµç®—
  REDEEMED   // å·²å…Œç¾
}
// ===== ä½¿ç”¨è€…ç®¡ç† =====

model User {
  id            String      @id @default(auto()) @map("_id") @db.ObjectId
  did           String      @unique // W3C DID (ä¾‹å¦‚: did:key:z6Mk...)
  didDocument   Json?       // DID Document (å®Œæ•´çš„ W3C DID Document)
  didSeed       String?     // DID ç¨®å­ (åŠ å¯†å­˜å„²,ç”¨æ–¼é‡å»º DID)
  role          UserRole
  kycStatus     KycStatus   @default(PENDING)
  walletAddress String?     @unique
  email         String?     // ç§»é™¤ @uniqueï¼Œå› ç‚º MongoDB æœƒæŠŠå¤šå€‹ null è¦–ç‚ºé‡è¤‡
  phoneNumber   String?
  lastLoginAt   DateTime?   // æœ€å¾Œç™»å…¥æ™‚é–“
  createdAt     DateTime    @default(now())
  updatedAt     DateTime    @updatedAt

  // é—œè¯
  kycRecords    KycRecord[]
  taxClaims     TaxClaim[]
  investments   Investment[]
  notifications Notification[]
  merchants     Merchant[] // QR Code æ”¯ä»˜ - åº—å®¶
  payments      Payment[] // QR Code æ”¯ä»˜ - æ”¯ä»˜è¨˜éŒ„

  @@map("users")
}

model KycRecord {
  id               String    @id @default(auto()) @map("_id") @db.ObjectId
  userId           String    @db.ObjectId
  fullName         String
  passportNumber   String
  passportImageUrl String
  faceImageUrl     String
  nationality      String
  dateOfBirth      DateTime
  status           KycStatus @default(PENDING)
  verifiedAt       DateTime?
  reviewedAt       DateTime?
  rejectedReason   String?

  // âœ… Self SDK ç›¸é—œæ¬„ä½
  verifiableCredential Json?     // KYC å¯é©—è­‰æ†‘è­‰ (Verifiable Credential)
  credentialId         String?   // æ†‘è­‰ ID
  issuerDID            String?   // ç°½ç™¼è€… DID (å¹³å°çš„ç®¡ç†å“¡ DID)
  didDocumentHash      String?   // DID Document Hash (ç”¨æ–¼éˆä¸Šé©—è­‰)

  // ğŸ”— Celo éˆä¸Šé©—è­‰æ¬„ä½
  celoTxHash           String?   // Celo äº¤æ˜“å“ˆå¸Œ
  celoBlockNumber      Int?      // Celo å€å¡Šè™Ÿ
  celoProofHash        String?   // Proof Hash (é˜²æ­¢é‡æ”¾æ”»æ“Š)
  celoVerifiedAt       DateTime? // Celo éˆä¸Šé©—è­‰æ™‚é–“

  createdAt        DateTime  @default(now())
  updatedAt        DateTime  @updatedAt

  // é—œè¯
  user User @relation(fields: [userId], references: [id])

  @@map("kyc_records")
}

// ===== é€€ç¨…ç”³è«‹ =====

model TaxClaim {
  id              String       @id @default(auto()) @map("_id") @db.ObjectId
  userId          String       @db.ObjectId
  receiptImages   String[] // æ”¶æ“šåœ–ç‰‡ URLs
  receiptImageUrl String? // ä¸»è¦æ”¶æ“šåœ–ç‰‡ URL (å‘å¾Œå…¼å®¹)
  merchantName    String? // å•†å®¶åç¨±
  purchaseDate    String? // è³¼è²·æ—¥æœŸ
  entryFlight     String? // å…¥å¢ƒèˆªç­è™Ÿç¢¼
  entryFlightDate DateTime? // å…¥å¢ƒèˆªç­æ—¥æœŸ
  exitFlight      String? // å‡ºå¢ƒèˆªç­è™Ÿç¢¼
  exitFlightDate  DateTime? // å‡ºå¢ƒèˆªç­æ—¥æœŸ
  ocrResult       Json? // OCR è§£æçµæœ
  ocrData         Json? // OCR åŸå§‹æ•¸æ“š (åˆ¥å)
  originalAmount  Float // åŸå§‹é‡‘é¡
  taxAmount       Float // é€€ç¨…é‡‘é¡
  taxCoinAmount   Float // TaxCoin æ•¸é‡
  status          ClaimStatus  @default(PENDING)
  nftTokenId      String?      @unique // NFT Token ID
  reviewedBy      String? // å¯©æ ¸è€… ID
  reviewedAt      DateTime?
  rejectedReason  String?
  disbursedAt     DateTime?
  createdAt       DateTime     @default(now())
  updatedAt       DateTime     @updatedAt

  // é—œè¯
  user        User          @relation(fields: [userId], references: [id])
  nft         TaxClaimNft?
  rwaPoolItem RwaPoolItem?

  @@map("tax_claims")
}

model TaxClaimNft {
  id          String   @id @default(auto()) @map("_id") @db.ObjectId
  taxClaimId  String   @unique @db.ObjectId
  nftTokenId  String   @unique // Sui NFT Object ID
  metadataUri String
  mintedAt    DateTime @default(now())

  // é—œè¯
  taxClaim TaxClaim @relation(fields: [taxClaimId], references: [id])

  @@map("tax_claim_nfts")
}

// ===== RWA æŠ•è³‡æ±  =====

enum RiskLevel {
  LOW    // ä½é¢¨éšª
  MEDIUM // ä¸­é¢¨éšª
  HIGH   // é«˜é¢¨éšª
}

model RwaPool {
  id                 String     @id @default(auto()) @map("_id") @db.ObjectId
  poolName           String
  name               String     @default("") // æ± å­åç¨± (åˆ¥å)
  description        String?    // æ± å­æè¿°
  targetAmount       Float // ç›®æ¨™å‹Ÿé›†é‡‘é¡
  currentAmount      Float      @default(0) // ç•¶å‰å‹Ÿé›†é‡‘é¡
  yieldRate          Float // é æœŸæ”¶ç›Šç‡ (%)
  riskLevel          RiskLevel  @default(MEDIUM) // é¢¨éšªç­‰ç´š
  maturityDate       DateTime // åˆ°æœŸæ—¥
  status             PoolStatus @default(RECRUITING)
  poolContractId     String?    @unique // Sui Pool Contract Object ID
  totalTokenSupply   Float? // ä»£å¹£ç¸½ä¾›æ‡‰é‡
  createdAt          DateTime   @default(now())
  updatedAt          DateTime   @updatedAt

  // é—œè¯
  items       RwaPoolItem[]
  investments Investment[]

  @@map("rwa_pools")
}

model RwaPoolItem {
  id         String   @id @default(auto()) @map("_id") @db.ObjectId
  poolId     String   @db.ObjectId
  taxClaimId String   @unique @db.ObjectId
  addedAt    DateTime @default(now())

  // é—œè¯
  pool     RwaPool  @relation(fields: [poolId], references: [id])
  taxClaim TaxClaim @relation(fields: [taxClaimId], references: [id])

  @@map("rwa_pool_items")
}

// ===== æŠ•è³‡è¨˜éŒ„ =====

enum InvestmentStatus {
  ACTIVE    // é€²è¡Œä¸­
  REDEEMED  // å·²è´–å›
  CANCELLED // å·²å–æ¶ˆ
}

model Investment {
  id                String           @id @default(auto()) @map("_id") @db.ObjectId
  userId            String           @db.ObjectId
  poolId            String           @db.ObjectId
  investmentAmount  Float // æŠ•è³‡é‡‘é¡
  tokenAmount       Float // ç²å¾—çš„ä»£å¹£æ•¸é‡
  yieldAmount       Float? // æ”¶ç›Šé‡‘é¡
  yieldRate         Float? // æ”¶ç›Šç‡
  status            InvestmentStatus @default(ACTIVE)
  investedAt        DateTime         @default(now()) // æŠ•è³‡æ™‚é–“
  redeemedAt        DateTime?
  transactionHash   String?          @unique // Sui Transaction Hash
  poolShareNftId    String?          @unique // Pool Share NFT Object ID
  createdAt         DateTime         @default(now())
  updatedAt         DateTime         @updatedAt

  // é—œè¯
  user User    @relation(fields: [userId], references: [id])
  pool RwaPool @relation(fields: [poolId], references: [id])

  @@map("investments")
}

// ===== é€šçŸ¥ç³»çµ± =====

model Notification {
  id        String   @id @default(auto()) @map("_id") @db.ObjectId
  userId    String   @db.ObjectId
  title     String
  message   String
  type      String // é€šçŸ¥é¡å‹: TAX_APPROVED, INVESTMENT_SUCCESS, POOL_MATURED, etc.
  isRead    Boolean  @default(false)
  createdAt DateTime @default(now())

  // é—œè¯
  user User @relation(fields: [userId], references: [id])

  @@map("notifications")
}

// ===== ç³»çµ±è¨­å®š =====

model SystemConfig {
  id        String   @id @default(auto()) @map("_id") @db.ObjectId
  key       String   @unique // é…ç½®éµå
  value     String // é…ç½®å€¼ (JSON string)
  updatedAt DateTime @updatedAt

  @@map("system_config")
}

// ===== å¯©è¨ˆæ—¥èªŒ =====

model AuditLog {
  id         String   @id @default(auto()) @map("_id") @db.ObjectId
  userId     String? // æ“ä½œè€… ID (å¯ç‚ºç³»çµ±)
  action     String // æ“ä½œé¡å‹
  entityType String // å¯¦é«”é¡å‹
  entityId   String // å¯¦é«” ID
  changes    Json? // è®Šæ›´å…§å®¹
  details    Json? // è©³ç´°è³‡è¨Š (åˆ¥å)
  ipAddress  String?
  userAgent  String?
  createdAt  DateTime @default(now())

  @@map("audit_logs")
}

// ===== QR Code æ”¯ä»˜åŠŸèƒ½ =====

enum MerchantStatus {
  ACTIVE    // ç‡Ÿæ¥­ä¸­
  SUSPENDED // å·²æš«åœ
}

enum ProductStatus {
  ACTIVE   // ä¸Šæ¶ä¸­
  INACTIVE // å·²ä¸‹æ¶
}

enum PaymentStatus {
  PENDING   // å¾…æ”¯ä»˜
  COMPLETED // å·²å®Œæˆ
  FAILED    // å¤±æ•—
  CANCELLED // å·²å–æ¶ˆ
}

enum InvoiceStatus {
  ISSUED // å·²é–‹ç«‹
  VOIDED // å·²ä½œå»¢
}

model Merchant {
  id            String         @id @default(auto()) @map("_id") @db.ObjectId
  userId        String         @db.ObjectId
  merchantName  String // åº—å®¶åç¨±
  taxId         String         @unique // çµ±ä¸€ç·¨è™Ÿ
  ownerName     String // è² è²¬äººå§“å
  phone         String // è¯çµ¡é›»è©±
  address       String // åº—å®¶åœ°å€
  businessType  String // ç‡Ÿæ¥­é …ç›®
  walletAddress String // Sui éŒ¢åŒ…åœ°å€
  status        MerchantStatus @default(ACTIVE)
  createdAt     DateTime       @default(now())
  updatedAt     DateTime       @updatedAt

  // é—œè¯
  user     User      @relation(fields: [userId], references: [id])
  products Product[]
  payments Payment[]
  invoices Invoice[]

  @@map("merchants")
}

model Product {
  id          String        @id @default(auto()) @map("_id") @db.ObjectId
  merchantId  String        @db.ObjectId
  name        String // å•†å“åç¨±
  description String // å•†å“æè¿°
  price       Float // å–®åƒ¹ (TWD)
  stock       Int // åº«å­˜æ•¸é‡
  category    String // åˆ†é¡
  imageUrl    String? // å•†å“åœ–ç‰‡
  status      ProductStatus @default(ACTIVE)
  createdAt   DateTime      @default(now())
  updatedAt   DateTime      @updatedAt

  // é—œè¯
  merchant Merchant @relation(fields: [merchantId], references: [id])

  @@map("products")
}

model Payment {
  id              String        @id @default(auto()) @map("_id") @db.ObjectId
  customerId      String?       @db.ObjectId // é—œè¯ Userï¼ˆæ—…å®¢ï¼‰- æƒæå¾Œæ‰å¡«å…¥
  merchantId      String        @db.ObjectId
  orderNumber     String        @unique // è¨‚å–®ç·¨è™Ÿ
  items           Json // å•†å“æ˜ç´° (PaymentItem[])
  subtotal        Float // å°è¨ˆ
  tax             Float // ç¨…é¡
  total           Float // ç¸½è¨ˆ
  status          PaymentStatus @default(PENDING)
  transactionHash String?       @unique // å€å¡Šéˆäº¤æ˜“å“ˆå¸Œ
  invoiceId       String?       @db.ObjectId // é—œè¯ Invoice
  qrCodeData      String // QR Code åŸå§‹æ•¸æ“š
  expiresAt       DateTime // QR Code éæœŸæ™‚é–“
  paidAt          DateTime? // æ”¯ä»˜æ™‚é–“
  createdAt       DateTime      @default(now())
  updatedAt       DateTime      @updatedAt

  // é—œè¯
  customer User?    @relation(fields: [customerId], references: [id])
  merchant Merchant @relation(fields: [merchantId], references: [id])
  invoice  Invoice?

  @@map("payments")
}

model Invoice {
  id             String        @id @default(auto()) @map("_id") @db.ObjectId
  paymentId      String        @unique @db.ObjectId
  invoiceNumber  String        @unique // ç™¼ç¥¨è™Ÿç¢¼
  invoiceDate    DateTime // ç™¼ç¥¨æ—¥æœŸ
  merchantTaxId  String // è³£æ–¹çµ±ç·¨
  merchantName   String // è³£æ–¹åç¨±
  buyerTaxId     String? // è²·æ–¹çµ±ç·¨ï¼ˆå¯é¸ï¼‰
  buyerName      String? // è²·æ–¹åç¨±ï¼ˆå¯é¸ï¼‰
  items          Json // ç™¼ç¥¨å“é …
  subtotal       Float // éŠ·å”®é¡
  tax            Float // ç¨…é¡
  total          Float // ç¸½è¨ˆ
  taxRate        Float         @default(0.05) // ç¨…ç‡ï¼ˆé è¨­ 5%ï¼‰
  qrCodeData     String // ç™¼ç¥¨ QR Code æ•¸æ“š
  status         InvoiceStatus @default(ISSUED)
  voidedAt       DateTime? // ä½œå»¢æ™‚é–“
  voidReason     String? // ä½œå»¢åŸå› 
  merchantId     String        @db.ObjectId
  createdAt      DateTime      @default(now())
  updatedAt      DateTime      @updatedAt

  // é—œè¯
  payment  Payment  @relation(fields: [paymentId], references: [id])
  merchant Merchant @relation(fields: [merchantId], references: [id])

  @@map("invoices")
}

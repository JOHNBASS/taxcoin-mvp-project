// Prisma Schema for TAXCOIN MVP
// 參考: .specify/features/taxcoin-mvp-platform/data-model.md

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "mongodb"
  url      = env("DATABASE_URL")
}

// ===== 列舉類型 =====

enum UserRole {
  TOURIST // 旅客
  INVESTOR // 投資者
  ADMIN // 管理員
}

enum KycStatus {
  PENDING // 待驗證
  VERIFIED // 已驗證
  REJECTED // 已拒絕
}

enum ClaimStatus {
  PENDING // 待審核
  APPROVED // 已核准
  REJECTED // 已拒絕
  DISBURSED // 已發放
}

enum PoolStatus {
  RECRUITING // 募集中
  FULL // 已滿額
  MATURED // 已到期
  REDEEMED // 已兌現
}

// ===== 使用者管理 =====

model User {
  id            String    @id @default(auto()) @map("_id") @db.ObjectId
  did           String    @unique // 去中心化身份識別碼
  role          UserRole
  kycStatus     KycStatus @default(PENDING)
  walletAddress String?   @unique
  email         String?   @unique
  phoneNumber   String?
  lastLoginAt   DateTime? // 最後登入時間
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  // 關聯
  kycRecords    KycRecord[]
  taxClaims     TaxClaim[]
  investments   Investment[]
  notifications Notification[]

  @@map("users")
}

model KycRecord {
  id               String    @id @default(auto()) @map("_id") @db.ObjectId
  userId           String    @db.ObjectId
  fullName         String
  passportNumber   String
  passportImageUrl String
  faceImageUrl     String
  nationality      String
  dateOfBirth      DateTime
  status           KycStatus @default(PENDING)
  verifiedAt       DateTime?
  reviewedAt       DateTime?
  rejectedReason   String?
  createdAt        DateTime  @default(now())
  updatedAt        DateTime  @updatedAt

  // 關聯
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("kyc_records")
}

// ===== 退稅申請 =====

model TaxClaim {
  id              String      @id @default(auto()) @map("_id") @db.ObjectId
  userId          String      @db.ObjectId
  receiptImages   String[] // 收據圖片 URLs
  receiptImageUrl String? // 主要收據圖片 URL (向後兼容)
  merchantName    String? // 商家名稱
  purchaseDate    String? // 購買日期
  ocrResult       Json? // OCR 解析結果
  ocrData         Json? // OCR 原始數據 (別名)
  originalAmount  Float // 原始金額
  taxAmount       Float // 退稅金額
  taxCoinAmount   Float // TaxCoin 數量
  status          ClaimStatus @default(PENDING)
  nftTokenId      String?     @unique // NFT Token ID
  reviewedBy      String? // 審核者 ID
  reviewedAt      DateTime?
  rejectedReason  String?
  disbursedAt     DateTime?
  createdAt       DateTime    @default(now())
  updatedAt       DateTime    @updatedAt

  // 關聯
  user        User         @relation(fields: [userId], references: [id], onDelete: Cascade)
  nft         TaxClaimNft?
  rwaPoolItem RwaPoolItem?

  @@map("tax_claims")
}

model TaxClaimNft {
  id          String   @id @default(auto()) @map("_id") @db.ObjectId
  taxClaimId  String   @unique @db.ObjectId
  nftTokenId  String   @unique // Sui NFT Object ID
  metadataUri String
  mintedAt    DateTime @default(now())

  // 關聯
  taxClaim TaxClaim @relation(fields: [taxClaimId], references: [id], onDelete: Cascade)

  @@map("tax_claim_nfts")
}

// ===== RWA 投資池 =====

enum RiskLevel {
  LOW // 低風險
  MEDIUM // 中風險
  HIGH // 高風險
}

model RwaPool {
  id               String     @id @default(auto()) @map("_id") @db.ObjectId
  poolName         String
  name             String     @default("") // 池子名稱 (別名)
  description      String? // 池子描述
  targetAmount     Float // 目標募集金額
  currentAmount    Float      @default(0) // 當前募集金額
  yieldRate        Float // 預期收益率 (%)
  riskLevel        RiskLevel  @default(MEDIUM) // 風險等級
  maturityDate     DateTime // 到期日
  status           PoolStatus @default(RECRUITING)
  poolContractId   String?    @unique // Sui Pool Contract Object ID
  totalTokenSupply Float? // 代幣總供應量
  createdAt        DateTime   @default(now())
  updatedAt        DateTime   @updatedAt

  // 關聯
  items       RwaPoolItem[]
  investments Investment[]

  @@map("rwa_pools")
}

model RwaPoolItem {
  id         String   @id @default(auto()) @map("_id") @db.ObjectId
  poolId     String   @db.ObjectId
  taxClaimId String   @unique @db.ObjectId
  addedAt    DateTime @default(now())

  // 關聯
  pool     RwaPool  @relation(fields: [poolId], references: [id], onDelete: Cascade)
  taxClaim TaxClaim @relation(fields: [taxClaimId], references: [id], onDelete: Cascade)

  @@map("rwa_pool_items")
}

// ===== 投資記錄 =====

enum InvestmentStatus {
  ACTIVE // 進行中
  REDEEMED // 已贖回
  CANCELLED // 已取消
}

model Investment {
  id               String           @id @default(auto()) @map("_id") @db.ObjectId
  userId           String           @db.ObjectId
  poolId           String           @db.ObjectId
  investmentAmount Float // 投資金額
  tokenAmount      Float // 獲得的代幣數量
  yieldAmount      Float? // 收益金額
  yieldRate        Float? // 收益率
  status           InvestmentStatus @default(ACTIVE)
  investedAt       DateTime         @default(now()) // 投資時間
  redeemedAt       DateTime?
  transactionHash  String?          @unique // Sui Transaction Hash
  createdAt        DateTime         @default(now())
  updatedAt        DateTime         @updatedAt

  // 關聯
  user User    @relation(fields: [userId], references: [id], onDelete: Cascade)
  pool RwaPool @relation(fields: [poolId], references: [id], onDelete: Cascade)

  @@map("investments")
}

// ===== 通知系統 =====

model Notification {
  id        String   @id @default(auto()) @map("_id") @db.ObjectId
  userId    String   @db.ObjectId
  title     String
  message   String
  type      String // 通知類型: TAX_APPROVED, INVESTMENT_SUCCESS, POOL_MATURED, etc.
  isRead    Boolean  @default(false)
  createdAt DateTime @default(now())

  // 關聯
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("notifications")
}

// ===== 系統設定 =====

model SystemConfig {
  id        String   @id @default(auto()) @map("_id") @db.ObjectId
  key       String   @unique // 配置鍵名
  value     String // 配置值 (JSON string)
  updatedAt DateTime @updatedAt

  @@map("system_config")
}

// ===== 審計日誌 =====

model AuditLog {
  id         String   @id @default(auto()) @map("_id") @db.ObjectId
  userId     String? // 操作者 ID (可為系統)
  action     String // 操作類型
  entityType String // 實體類型
  entityId   String // 實體 ID
  changes    Json? // 變更內容
  details    Json? // 詳細資訊 (別名)
  ipAddress  String?
  userAgent  String?
  createdAt  DateTime @default(now())

  @@map("audit_logs")
}
